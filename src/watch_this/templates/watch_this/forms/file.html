<input type="hidden" name="upload">

<script>
    function getCookie(name) {
        const cookie = document.cookie.split(';')
            .map(cookie => cookie.split('='))
            .find(cookie => cookie[0] === name)

        return cookie ? cookie[1] : ""
    }

    const uploadInputs = document.getElementsByName('upload')
    const hiddenInput = uploadInputs.item(uploadInputs.length - 1)
</script>

{% include "django/forms/widgets/input.html" %}

<script>
    const videoFileInputs = document.getElementsByName('{{ widget.name }}')
    const videoFileInput = videoFileInputs.item(videoFileInputs.length - 1)

    function uploadFile(file) {
        videoFileInput.disabled = true
        const form = new FormData()
        form.append("file", file)
        fetch('{% url "watch_this:upload" %}', {
            method: 'POST',
            body: form,
            headers: {
                'x-csrftoken': getCookie('csrftoken')
            }
        }).then(response => {
            videoFileInput.disabled = false

            if (response.ok) {
                setSubmitDisabled(false)
                response.text().then(id => hiddenInput.value = id)
            } else {
                videoFileInput.value = null
            }
        })
    }

    videoFileInput.addEventListener('input', event => uploadFile(event.target.files[0]))
</script>

<script defer>
    function setSubmitDisabled(disabled) {
        for (const button of document.getElementsByTagName('input')) {
            if (button.type === 'submit') {
                button.disabled = disabled
            }
        }
    }

    setTimeout(() => setSubmitDisabled(true))
</script>
